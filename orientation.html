<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="misapplication-tap-highlight" content="no" />
    <meta name="HandheldFriendly" content="true" />
    <meta name="MobileOptimized" content="320" />
    <title>方向传感器</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .log-entry {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .log-entry-header {
            font-weight: bold;
            color: #333;
        }
        .log-entry-details {
            color: #555;
        }
    </style>
    <script type="text/javascript">
        var timestampArray = [];
        var msgArray = [];
        function absoluteFlag(flag, absolute, id){
            if(!flag){
                document.getElementById(id).textContent = '';
                return;
            }
            if(absolute) {
                document.getElementById(id).textContent = absolute;
            } else {
                document.getElementById(id).textContent = absolute;
            }
        }
        function log(timestamp, x, y, z) {
             document.getElementById('x').textContent = x;
             document.getElementById('y').textContent = y;
             document.getElementById('z').textContent = z;
             setTimestamp(timestamp, 'freq');

<!--             var msg = timestamp + ": " + x + ", " + y + ", "  + z;-->
<!--             msgArray.push(msg);-->
<!--             if (msgArray.length === 5) {-->
<!--                 document.getElementById('msg1').textContent = msgArray[0];-->
<!--                 document.getElementById('msg2').textContent = msgArray[1];-->
<!--                 document.getElementById('msg3').textContent = msgArray[2];-->
<!--                 document.getElementById('msg4').textContent = msgArray[3];-->
<!--                 document.getElementById('msg5').textContent = msgArray[4];-->
<!--                 msgArray = [];-->
<!--             }-->
        }
        function log2(timestamp, x, y, z) {
             document.getElementById('x2').textContent = x;
             document.getElementById('y2').textContent = y;
             document.getElementById('z2').textContent = z;
             setTimestamp(timestamp, 'freq2');
        }
        function log3(timestamp, arr) {
            document.getElementById('x3').textContent = arr[0];
            document.getElementById('y3').textContent = arr[1];
            document.getElementById('z3').textContent = arr[2];
            document.getElementById('w3').textContent = arr[3];
            setTimestamp(timestamp, 'freq3');
        }
        function setTimestamp(timestamp, id) {
            timestampArray.push(timestamp);
            console.log(`${timestampArray.length}`);
            if ((timestampArray.length - 60) === 0) {
                var sum = 0;
                for (var i = 0; i < timestampArray.length - 1; i++) {
                    sum = sum + timestampArray[i + 1] - timestampArray[i];
                }
                var avg = sum / 59;
                var feq = 1000 / avg;
                document.getElementById(id).textContent = feq.toFixed(2) + " HZ";
                timestampArray = [];
            }
        }

        var Ori;
        function w3caccfreq1() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                console.log(`[NEUJS] Permissions: ${result.state}`);
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori = new RelativeOrientationSensor({frequency: 1});
                let max_magnitude = 0;
                Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
                Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
                Ori.addEventListener('reading', () => {
                    log3(Ori.timestamp, Ori.quaternion)
                });
                Ori.start();
            });
        }

        function w3caccfreq5() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori = new RelativeOrientationSensor({frequency: 5});
                let max_magnitude = 0;
                Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
                Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
                Ori.addEventListener('reading', () => {
                    log3(Ori.timestamp, Ori.quaternion)
                });
                Ori.start();
            });
        }

        function w3caccfreq10() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori = new RelativeOrientationSensor({frequency: 10});
                let max_magnitude = 0;
                Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
                Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
                Ori.addEventListener('reading', () => {
                    log3(Ori.timestamp, Ori.quaternion)
                });
                Ori.start();
            });
        }

        function w3caccfreq100() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori = new RelativeOrientationSensor({frequency: 100});
                let max_magnitude = 0;
                Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
                Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
                Ori.addEventListener('reading', () => {
                    log3(Ori.timestamp, Ori.quaternion)
                });
                Ori.start();
            });
        }

        function w3caccfreq300() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori = new RelativeOrientationSensor({frequency: 300});
                let max_magnitude = 0;
                Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
                Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
                Ori.addEventListener('reading', () => {
                    log3(Ori.timestamp, Ori.quaternion)
                });
                Ori.start();
            });
        }

        function delw3cacc() {
            navigator.permissions.query({ name: 'gyroscope' }).then(result => {
                if (result.state === 'denied') {
                    console.log('[NEU]Permission to use gyroscope sensor is denied.');
                    return;
                }

                Ori.removeEventListener('activate', () => console.log('[NEU]Ready to remove.'));
                Ori.stop();
            });
        }

        function checkSensorsPermission() {
            document.getElementById('log3').textContent = '检查权限';
            Promise.all([
                navigator.permissions.query({ name: 'gyroscope' })
                ]).then(results => {
                    const gyroscopePermission = results[0];
                    document.getElementById('log3').textContent = '检查权限成功';
                    console.log(`[NEU]方向传感器权限: ${gyroscopePermission.state}`);
            }).catch(error => {
                console.error('[NEU]权限查询失败:', error);
                document.getElementById('log3').textContent = '检查权限失败' + error;
            });
        }

        function getOri() {
            if ('DeviceOrientationEvent' in window) {
                document.getElementById('log').textContent = '此浏览器支持DeviceOrientationEvent';
                window.addEventListener('deviceorientation', handleOrientationEvent, false);
            } else {
              document.getElementById('log').textContent = '此浏览器不支持DeviceOrientationEvent';
            }
        }
        function delAcc() {
            if ('DeviceOrientationEvent' in window) {
              window.removeEventListener('deviceorientation', handleOrientationEvent, false);
            } else {
              console.log('此浏览器不支持DeviceOrientationEvent');
            }
        }
        function getOri2() {
            if ('DeviceOrientationEvent' in window) {
                document.getElementById('log2').textContent = '此浏览器支持deviceorientationabsolute';
                window.addEventListener('deviceorientationabsolute', handleOrientationEvent2, false);
            } else {
              document.getElementById('log2').textContent = '此浏览器不支持deviceorientationabsolute';
            }
        }
        function delAcc2() {
            if ('DeviceOrientationEvent' in window) {
              window.removeEventListener('deviceorientationabsolute', handleOrientationEvent2, false);
            } else {
              console.log('此浏览器不支持deviceorientationabsolute');
            }
        }

        let toggle = false;
        function handleOrientationEvent(event) {
            var absolute = event.absolute;
            var z = event.alpha;
            var x = event.beta;
            var y = event.gamma;
            toggle = !toggle;
            absoluteFlag(toggle, absolute, 'absolute');
            log(event.timeStamp, x, y, z);
        }

        let toggle2 = false;
        function handleOrientationEvent2(event) {
            var absolute = event.absolute;
            var z = event.alpha;
            var x = event.beta;
            var y = event.gamma;
            toggle2 = !toggle2;
            absoluteFlag(toggle, absolute, 'absolute2');
            log2(event.timeStamp, x, y, z);
        }

        function TestfrequencyIsCappedToAllowedMaximum() {
            Ori = new Gyroscope({frequency: 560});
            Ori.addEventListener('activate', () => console.log('[NEU]Ready to measure.'));
            Ori.addEventListener('error', error => console.log(`[NEU]Error: ${error.name}`));
            Ori.addEventListener('reading', () => {
                console.log(Ori.quaternion);
            });
            Ori.start();
            var freq = Ori.getSamplingFrequency();
            Ori.stop();
        }
    </script>
</head>
<body>
<div id="dcontent" class="dcontent">
    <h3>w3c测试项目:</h3>
    <ul class="dlist">
      <button type="button" onclick="w3caccfreq1()">w3c-freq1</button>
      <button type="button" onclick="w3caccfreq5()">w3c-freq5</button>
      <button type="button" onclick="w3caccfreq10()">w3c-freq10</button>
      <button type="button" onclick="w3caccfreq100()">w3c-freq100</button>
      <button type="button" onclick="w3caccfreq300()">w3c-freq300</button>
      <button type="button" onclick="delw3cacc()">w3cStop</button>
      <button type="button" onclick="checkSensorsPermission()">检查传感器权限w3c</button>
      <button type="button" onclick="TestfrequencyIsCappedToAllowedMaximum()">测试频率上限</button>
    </ul>
    <h3>方向传感器监听:</h3>
    <ul class="dlist">
      <li><button type="button" onclick="getOri()">获取设备当前方向</button></li>
      <li><button type="button" onclick="delAcc()">取消监听方向变化</button></li>
      <li><button type="button" onclick="getOri2()">获取设备当前方向(绝对位置)</button></li>
      <li><button type="button" onclick="delAcc2()">取消监听方向变化(绝对位置)</button></li>
    </ul>
</div>
<div id="output">
    <h1>w3c</h1>
    <h2 id = "log3"></h2>
    <p>x: <span id="x3">0</span></p>
    <p>y: <span id="y3">0</span></p>
    <p>z: <span id="z3">0</span></p>
    <p>w: <span id="w3">0</span></p>
    <h1 id = "freq3">0Hz</h1>

    <h1>方向数据</h1>
    <h2 id = "log"></h2>
    <p>absolute: <span id="absolute"></span></p>
    <p>x: <span id="x">0</span></p>
    <p>y: <span id="y">0</span></p>
    <p>z: <span id="z">0</span></p>
    <h1 id = "freq">0Hz</h1>

    <h1>方向数据:绝对位置</h1>
    <h2 id = "log2"></h2>
    <p>absolute: <span id="absolute2"></span></p>
    <p>x: <span id="x2">0</span></p>
    <p>y: <span id="y2">0</span></p>
    <p>z: <span id="z2">0</span></p>
    <h1 id = "freq2">0Hz</h1>

<!--    <div class="log-entry">-->
<!--        <div class="log-entry-details" id = "msg1"></div>-->
<!--    </div>-->
<!--    <div class="log-entry">-->
<!--        <div class="log-entry-details" id = "msg2"></div>-->
<!--    </div>-->
<!--    <div class="log-entry">-->
<!--        <div class="log-entry-details" id = "msg3"></div>-->
<!--    </div>-->
<!--    <div class="log-entry">-->
<!--        <div class="log-entry-details" id = "msg4"></div>-->
<!--    </div>-->
<!--    <div class="log-entry">-->
<!--        <div class="log-entry-details" id = "msg5"></div>-->
<!--    </div>-->
</div>
</body>

</html>
